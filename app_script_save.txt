const SHEET_ID = '...';
const SHEET_NAME = 'Sheet1'; // Change if your sheet has a different name

function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const originalMessage = payload.message || '';
    const timestamp = new Date();

    // Break message into lines (handles both \n and \r\n)
    const lines = originalMessage.split(/\r?\n/).map(line => line.trim()).filter(line => line);

    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);

    lines.forEach(line => {
      const processed = addKtoSmallNumbers(line);
      sheet.appendRow([timestamp, line, processed]);
    });

    return ContentService
      .createTextOutput(`âœ… Processed ${lines.length} line(s).`)
      .setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    return ContentService
      .createTextOutput("âŒ Error: " + err.toString())
      .setMimeType(ContentService.MimeType.TEXT);
  }
}

function addKtoSmallNumbers(text) {
  return text.replace(/\b(\d{1,3})(?!k)\b/g, (match, num) => {
    return parseInt(num) < 1000 ? num + 'k' : num;
  });
}
